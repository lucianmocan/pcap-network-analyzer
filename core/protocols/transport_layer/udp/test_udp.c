#include "udp.h"
#include <assert.h>

void test_parse_udp_ipv4()
{
    uint8_t udp_header[] = {
        0x01, 0xBB, // Source port (443)
        0xE5, 0x08, // Destination port (58632)
        0x00, 0x29, // Length (41)
        0x19, 0xBF,  // Checksum (0x19BF)
        0x48, 0xDA, 
        0xD3, 0x72, 0xC2, 0x78, 
        0x7F, 0x83, 0x44, 0x88, 
        0xB4, 0x23, 0x0E, 0xE2, 
        0x55, 0x64, 0xA4, 0x09, 
        0xCA, 0xC8, 0xA3, 0xA3, 
        0x84, 0x14, 0x66, 0xC5, 
        0x0F, 0x2F, 0x50, 0x58, 
        0x84, 0xEA, 0x45
    };

    uint8_t ipv4_header[] = {
        0x45, 0x00, 0x00, 0x3D, 0x00, 0x00, 0x40, 0x00,
        0x34, 0x11, 0x29, 0x95, 0x11, 0xF8, 0xFA, 0x04,
        0x0A, 0xC0, 0x06, 0x5F
    };

    my_ipv4_header_t ipv4 = parse_ipv4(ipv4_header, false);
    my_udp_header_t udp = parse_udp(udp_header, ipv4.raw_source_address, ipv4.raw_destination_address, IPPROTO_IPV4, false);

    assert(udp.source_port == 443);
    assert(udp.destination_port == 58632);
    assert(udp.length == 41);
    assert(udp.checksum == 0x19BF);
    assert(udp.checksum_correct == true);
}

void test_parse_udp_ipv6()
{
    uint8_t udpv6_header[] = {
        0xC8, 0xDE, // Source port (51422)
        0x27, 0x10, // Destination port (10000)
        0x00, 0x13, // Length (19)
        0x7e, 0x09, // Checksum (0x0026) but it is partial, the right checksum is 0x7e09
        0x68, 0x65, // wireshark says likely caused by "UDP checksum offload"
        0x6C, 0x6C, 0x6F, 0x20, 
        0x77, 0x6F, 0x72, 0x6C, 
        0x64
    };

    uint8_t ipv6_header[] = {
        0x60, 0x0C, 0x0A, 0x00, 0x00, 0x13, 0x11, 0x40, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01
    };

    my_ipv6_header_t ipv6 = parse_ipv6(ipv6_header, false);
    my_udp_header_t udp = parse_udp(udpv6_header, ipv6.raw_source_address, ipv6.raw_destination_address, IPPROTO_IPV6, false);

    assert(udp.source_port == 51422);
    assert(udp.destination_port == 10000);
    assert(udp.length == 19);
    assert(udp.checksum == 0x7e09);
    assert(udp.checksum_correct == true);
}


int main()
{
    test_parse_udp_ipv4();
    test_parse_udp_ipv6();
    return 0;
}